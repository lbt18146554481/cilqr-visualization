# 轨迹震荡问题修复说明

## 问题描述

优化轨迹出现震荡，移动距离没有改善。

## 问题分析

### 根本原因

轨迹空间长度短的问题**不是**因为权重设置，而是因为：

1. **速度被优化得过低**：优化器为了满足约束或最小化代价，将速度降低到接近0
2. **初始轨迹生成问题**：`const_velo_prediction` 使用恒定速度（初始速度），但优化后速度降低
3. **参考速度设置**：参考速度可能不够强，无法引导优化器保持足够的速度

### 震荡原因

1. **权重不平衡**：速度权重、加速度权重、曲率变化率权重之间的平衡被打破
2. **步长接受阈值过小**：导致优化器接受不稳定的步长
3. **ref_x_weight 过大**：可能导致过度优化，引起震荡

## 已回退的修改

1. ✅ 回退速度权重强制最小值（从 5.0 → 使用配置值）
2. ✅ 回退加速度权重强制最小值（从 1.0 → 使用配置值）
3. ✅ 回退曲率变化率权重强制最小值（从 15.0 → 使用配置值）
4. ✅ 回退参考速度限制（移除 80% 限制）
5. ✅ 增加步长接受阈值（从 0.3 → 0.5），减少震荡

## 当前配置

### 权重设置（已恢复平衡）

```cpp
config_.w_pos = 10.0;      // 位置权重（保持较大值，确保跟踪）
config_.w_vel = 1.0;       // 速度权重（使用配置值，不强制）
config_.w_heading = 20.0;  // 航向权重（保持较大值，转弯时重要）
config_.w_kappa = 10.0;    // 曲率权重（保持较大值）
config_.w_acc = 0.5;       // 加速度权重（使用配置值）
config_.w_dkappa = 25.0;   // 曲率变化率权重（使用配置值）
config_.ref_x_weight = 50.0;  // 参考轨迹权重（保持较大值）
```

### 优化参数

```cpp
config_.accept_step_threshold = 0.5;  // 增加步长接受阈值，减少震荡
config_.max_iter = 15;
config_.convergence_threshold = 0.05;
```

## 关于轨迹空间长度短的问题

这个问题**不是权重问题**，而是算法本身的特性：

1. **CILQR 是路径优化算法**，不是速度规划算法
2. 优化器会**在满足约束的前提下最小化代价**，如果速度降低能减少代价，它会这样做
3. **空间长度 = 速度 × 时间**，如果速度被优化得很低，空间长度自然就短

### 可能的解决方案（需要进一步研究）

1. **增加速度下界约束**：确保速度不低于某个最小值
2. **修改初始轨迹生成**：使用启发式轨迹的速度作为初始速度
3. **调整参考速度计算**：使用启发式轨迹的完整速度曲线，而不是平均值
4. **增加速度跟踪权重**：但需要平衡，避免震荡

## 建议

1. **先解决震荡问题**：当前配置应该能减少震荡
2. **如果轨迹空间长度仍然短**：这是算法特性，可能需要：
   - 调整启发式轨迹的速度规划
   - 或者接受优化轨迹的空间长度（优化器认为这是最优的）
   - 或者修改算法，增加速度下界约束

## 测试建议

重新运行测试，检查：
1. ✅ 震荡是否减少
2. ✅ 轨迹是否平滑
3. ⚠️ 空间长度可能仍然较短（这是算法特性，不是bug）
